<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fresh Market - Raíces Aconcagua Mendoza</title>
    <!-- Carga de Tailwind CSS para un diseño rápido y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la librería SheetJS (xlsx) para leer archivos de Excel/CSV (Necesario para cargar nueva lista) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados para la aplicación */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }

        /* Estilos específicos para la tabla de precios */
        .price-table {
            border-collapse: collapse;
            width: 100%;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        .price-table th, .price-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* Estilos para el pie de página de Autoservicio */
        .autoservicio-box {
            background-color: #e0f2f1; /* Un color suave para destacar */
            border-left: 5px solid #009688; /* Borde de color de marca */
        }

        /* *** Estilos de IMPRESIÓN (Cartelería) *** */
        @media print {
            body {
                background-color: white !important;
                padding: 0;
            }
            .print-hidden {
                display: none !important;
            }
            .container-main {
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
            }
            .price-table th, .price-table td {
                padding: 0.75rem; 
                border-bottom: 1px solid #cccccc;
            }
            .price-table th {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact; 
                /* CORRECCIÓN: Usamos la propiedad estándar "print-color-adjust" */
                print-color-adjust: exact;
            }
            .price-table {
                font-size: 10pt;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Contenedor Principal -->
    <div class="container-main max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10">
        
        <!-- Logo y Encabezado Fijo -->
        <div class="flex flex-col items-center border-b pb-6 mb-6">
            <!-- Simulación de Logo (Reemplazar con tu imagen si es necesario) -->
            <h1 class="text-xl font-bold text-gray-700">RAICES ACONCAGUA MENDOZA</h1>
            <h2 class="text-4xl font-extrabold mt-2 text-teal-700 tracking-tight">FRESH MARKET</h2>
        </div>

        <!-- Mensaje de Carga y Errores (print-hidden) -->
        <div id="loading-message" class="text-center p-4 text-gray-500 print-hidden">
            Cargando lista de precios...
        </div>
        <div id="error-message" class="text-center p-4 text-red-500 hidden print-hidden">
            Ocurrió un error al cargar los precios. Por favor, recargue la página.
        </div>
        
        <!-- MENSAJE DE ADMINISTRACIÓN (OCULTO POR DEFECTO) -->
        <div id="init-message-container" class="print-hidden hidden">
            <div id="init-message" class="text-center p-2 text-orange-500 text-sm rounded-md bg-orange-100 border border-orange-200">
                Base de datos de precios inicializada con datos por defecto.
            </div>
            <!-- Mensaje adicional de modo admin -->
            <p id="admin-notice" class="text-center mt-2 text-xs text-red-700 bg-red-100 border border-red-300 p-1 rounded">
                MODO ADMINISTRADOR ACTIVO: Los datos han sido cargados/limpiados. Remueva `?admin=true` del URL para ocultar este mensaje.
            </p>
        </div>


        <!-- Tabla de Productos (Renderizada por JS) -->
        <div class="overflow-x-auto">
            <table class="price-table">
                <thead>
                    <tr class="bg-teal-50 text-teal-800 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 font-bold w-1/3">Descripción (ES)</th>
                        <th class="py-3 px-6 font-bold w-1/3">Description (EN)</th>
                        <th class="py-3 px-6 font-bold w-1/6 text-right">Precio</th>
                    </tr>
                </thead>
                <tbody id="products-list" class="text-gray-700 text-base font-light">
                    <!-- Las filas de productos se insertarán aquí por JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Sección de Autoservicio 24 HS -->
        <div class="autoservicio-box p-6 mt-8 rounded-lg">
            <h3 class="text-lg sm:text-xl font-bold mb-2 text-teal-800">AUTOSERVICIO 24 HS</h3>
            <p class="text-sm sm:text-base mb-3 text-gray-800">
                **Estimado Huésped:** El sistema es auto servicio, al retirar su producto deberá completar la comanda
                indicando su número de habitación y su nombre completo, luego depositar el papel
                en la urna para que se le cargue a su cuenta.
            </p>
            <hr class="border-teal-400 my-3">
            <p class="text-sm sm:text-base text-gray-700 italic">
                **Dear Guest:** The system is self-service. When withdrawing a product, you must complete the order
                indicating your room number and your full name, then deposit the paper into the box
                so that it will be added to your account.
            </p>
        </div>

        <!-- Botones de Administración (Carga y Imprimir) -->
        <div id="admin-controls" class="text-center mt-8 print-hidden hidden space-y-4">
            
            <!-- 1. Carga de Nueva Lista (CSV/Excel) -->
            <div class="flex items-center justify-center space-x-4">
                <!-- Input de Archivo Oculto -->
                <input type="file" id="file-input" accept=".csv, .xlsx, .xls, .ods" class="hidden" onchange="window.handleFileUpload(event)">
                
                <!-- Botón de Carga -->
                <button onclick="document.getElementById('file-input').click()" class='bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300'>
                    Cargar Nueva Lista (CSV/Excel)
                </button>
            </div>

            <!-- Separador -->
            <div class="pt-4 border-t border-gray-200">
                <p class="text-sm text-gray-500 font-semibold mb-3">O</p>
            </div>

            <!-- 2. Impresión -->
            <div>
                <button id="print-button" onclick="window.print()" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300">
                    Imprimir para Cartelería
                </button>
                <p class="mt-3 text-sm text-gray-600 font-semibold">
                    (Atajo de teclado: **Ctrl + P** o **Cmd + P**)
                </p>
            </div>
        </div>
    </div>

    <!-- Script de Firebase y Lógica -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, getDocs, addDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Configuración de FALLBACK (usando las claves de 'control-piscina-48181') ---
        const FALLBACK_FIREBASE_CONFIG = {
            apiKey: "AIzaSyD_vUGs0iDY0w45OlFjPCaOX58YI7J0xDI",
            authDomain: "control-piscina-48181.firebaseapp.com",
            projectId: "control-piscina-48181",
            storageBucket: "control-piscina-48181.firebasestorage.app",
            appId: "1:651276695583:web:02a25b22bcb52d5a05fd2a"
        };
        // ---------------------------------------------------------------------------------

        // Variables Globales del Entorno (MANDATORIO)
        let firebaseConfig = FALLBACK_FIREBASE_CONFIG;
        let appId = FALLBACK_FIREBASE_CONFIG.projectId; // Usar projectId como fallback para AppId si es necesario
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (typeof __firebase_config !== 'undefined') {
            try {
                const envConfig = JSON.parse(__firebase_config);
                if (Object.keys(envConfig).length > 0) {
                    firebaseConfig = envConfig;
                }
            } catch (e) {
                console.warn("Error al parsear __firebase_config. Usando fallback.");
            }
        }
        
        if (typeof __app_id !== 'undefined' && __app_id.length > 0) {
             appId = __app_id;
        } else {
             appId = firebaseConfig.projectId;
        }

        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const initMessageContainer = document.getElementById('init-message-container');
        const initMessage = document.getElementById('init-message');
        const adminControls = document.getElementById('admin-controls');
        const productsListBody = document.getElementById('products-list');
        
        let db, auth;
        const COLLECTION_NAME = 'menu_market';

        const urlParams = new URLSearchParams(window.location.search);
        const isAdminMode = urlParams.get('admin') === 'true';

        // Lista de productos por defecto (fallback y carga inicial en modo admin)
        const INITIAL_PRODUCTS = [
            { descripcion_es: "Agua Mineral", description_en: "Mineral water", precio: 4200 },
            { descripcion_es: "Café", description_en: "Coffee", precio: 4500 },
            { descripcion_es: "Cerveza Lata", description_en: "Canned Beer", precio: 6000 },
            { descripcion_es: "Coca Cola", description_en: "Coca Cola", precio: 4200 },
            { descripcion_es: "Doritos Queso", description_en: "Doritos Cheese", precio: 7800 },
            { descripcion_es: "Ensalada de Frutas", description_en: "Fruit Salad", precio: 6000 },
            { descripcion_es: "Fanta", description_en: "Fanta", precio: 4200 },
            { descripcion_es: "Sandwich de Jamón y Queso", description_en: "Ham and Cheese Sandwich", precio: 3800 },
            { descripcion_es: "Galletas Mini Oreo", description_en: "Mini Oreo Cookies", precio: 2600 },
            { descripcion_es: "Galletas Toddy", description_en: "Toddy Cookies", precio: 5300 },
            { descripcion_es: "Infusiones, Té", description_en: "Infusions, Tea", precio: 1500 },
            { descripcion_es: "Jugo de Frutas", description_en: "Fruit Juice", precio: 6000 },
            { descripcion_es: "Mix Frutos Secos", description_en: "Mixed Nuts", precio: 5500 },
            { descripcion_es: "Mix Mani", description_en: "Mix Mani", precio: 7000 },
            { descripcion_es: "Cheetos Queso", description_en: "Cheetos Cheese", precio: 8400 },
            { descripcion_es: "Papas Fritas Lays", description_en: "Lays Potato Chips", precio: 8500 },
            { descripcion_es: "Sprite", description_en: "Sprite", precio: 4200 },
            { descripcion_es: "Vino tinto", description_en: "Red wine", precio: 16400 },
            { descripcion_es: "Yogurt 160g", description_en: "Yogurt 160g", precio: 4600 },
        ];


        // Función para convertir la data de precio a string de moneda
        const formatPrice = (price) => {
            if (typeof price !== 'number') return '$ N/A';
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 0
            }).format(price);
        };

        /**
         * Intenta borrar todos los documentos de la colección.
         */
        async function deleteCollection(productsColRef) {
            try {
                initMessage.textContent = 'Borrando datos antiguos de la base de datos...';
                const snapshot = await getDocs(productsColRef);
                const batch = writeBatch(db);

                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                console.log(`Eliminados ${snapshot.size} documentos antiguos.`);
                initMessage.textContent = 'Datos antiguos borrados exitosamente.';
            } catch (e) {
                console.error("Error durante la eliminación de datos:", e);
                initMessage.textContent = `Advertencia: Error al borrar datos antiguos. Revise las reglas de escritura. ${e.message}`;
            }
        }
        
        /**
         * Carga los datos iniciales.
         * @param {object} productsColRef - Referencia a la colección de productos.
         * @param {Array<object>} productsToLoad - Array de objetos de producto.
         */
        async function initializeData(productsColRef, productsToLoad) {
            try {
                initMessage.textContent = `Cargando ${productsToLoad.length} nuevos productos...`;

                const batch = writeBatch(db);
                productsToLoad.forEach(product => {
                    const newDocRef = doc(productsColRef);
                    batch.set(newDocRef, product);
                });

                await batch.commit();
                
                console.log("Datos cargados exitosamente.");
                initMessage.textContent = `Base de datos de precios actualizada con ${productsToLoad.length} productos.`;
                setTimeout(() => initMessageContainer.classList.add('hidden'), 5000); 

            } catch (e) {
                console.error("Error durante la carga de datos:", e);
                initMessage.textContent = `Advertencia: Error al cargar datos. Revise las reglas de escritura. ${e.message}`;
                initMessageContainer.classList.remove('hidden');
            }
        }
        
        /**
         * Parsea el archivo de Excel/CSV a un Array de Objetos de Producto.
         * Espera columnas llamadas "Descripción", "Description" y "Precio".
         */
        function parsePriceListExcel(buffer) {
            try {
                // Lee el buffer binario
                const workbook = XLSX.read(buffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];

                // Convierte la hoja a formato JSON con encabezados como Array de Arrays
                const aoaData = XLSX.utils.sheet_to_json(worksheet, {
                    header: 1, 
                    raw: false,
                    defval: ''
                });

                if (aoaData.length <= 1) return []; // Solo encabezado o vacío

                const headers = aoaData[0].map(h => h ? h.toString().trim() : '');
                const products = [];

                // Normalización de búsqueda de encabezados
                const normalize = (str) => str.toLowerCase().replace(/[^a-zñáéíóú]/g, '');
                const colIndex = {
                    es: headers.findIndex(h => normalize(h).includes('descripcion') || normalize(h).includes('producto')),
                    en: headers.findIndex(h => normalize(h).includes('description') || normalize(h).includes('english')),
                    price: headers.findIndex(h => normalize(h).includes('precio') || normalize(h).includes('price'))
                };

                // Validar que se encontraron las columnas críticas
                if (colIndex.es === -1 || colIndex.en === -1 || colIndex.price === -1) {
                    throw new Error("No se encontraron las columnas requeridas: 'Descripción' (ES), 'Description' (EN) y 'Precio'. Revise los encabezados.");
                }

                // Iterar sobre los datos (saltando el encabezado en i=1)
                for (let i = 1; i < aoaData.length; i++) {
                    const row = aoaData[i];

                    const rawPrice = row[colIndex.price];
                    let numericPrice = parseFloat(String(rawPrice).replace('$', '').replace(/\./g, '').replace(/,/g, '.').trim());

                    if (isNaN(numericPrice)) {
                        // Intentar corregir formato de miles (si viene como "1.200")
                        const cleanPrice = String(rawPrice).replace(/\./g, ''); 
                        numericPrice = parseFloat(cleanPrice);
                    }

                    // Multiplicar por 100 y redondear si es decimal para manejarlo como entero (centavos)
                    // Luego se divide por 100 para obtener el valor real.
                    // Aquí simplemente lo mantenemos como el valor que ingresó el usuario (ej: 4200)
                    
                    // Asegurar que el precio es un número entero para la base de datos (como se usa en el array INITIAL_PRODUCTS)
                    numericPrice = Math.round(numericPrice); 
                    
                    products.push({
                        descripcion_es: String(row[colIndex.es] || '').trim(),
                        description_en: String(row[colIndex.en] || '').trim(),
                        precio: numericPrice
                    });
                }
                
                return products.filter(p => p.descripcion_es.length > 0 && p.precio > 0);

            } catch (error) {
                console.error("Error al parsear Excel/CSV:", error);
                throw new Error(`Error de formato de archivo: ${error.message}`);
            }
        }
        
        /**
         * Maneja la subida del archivo XLSX/XLS/CSV, lo parsea y actualiza la BD.
         */
        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            initMessage.textContent = `Leyendo archivo: ${file.name}...`;
            initMessageContainer.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = async function(e) {
                const buffer = e.target.result;
                let parsedData;
                
                try {
                    // El parser de SheetJS soporta todos los formatos.
                    parsedData = parsePriceListExcel(buffer); 
                } catch (error) {
                    errorMessage.textContent = error.message;
                    errorMessage.classList.remove('hidden');
                    initMessageContainer.classList.add('hidden');
                    return;
                }
                
                if (parsedData.length === 0) {
                    errorMessage.textContent = "El archivo está vacío o no se pudieron extraer productos válidos.";
                    errorMessage.classList.remove('hidden');
                    initMessageContainer.classList.add('hidden');
                    return;
                }
                
                // Si el parseo es exitoso, actualizamos la base de datos.
                const collectionPath = `/artifacts/${appId}/public/data/${COLLECTION_NAME}`;
                const productsColRef = collection(db, collectionPath);
                
                await deleteCollection(productsColRef);
                await initializeData(productsColRef, parsedData);
            };
            
            // Leemos el archivo como un ArrayBuffer
            reader.readAsArrayBuffer(file);
            event.target.value = null; // Limpiar input para permitir la recarga del mismo archivo
        };


        // Función principal de inicialización y carga de datos
        async function initApp() {
            try {
                if (!firebaseConfig.projectId) {
                    throw new Error("La configuración de Firebase está vacía o incompleta.");
                }
                
                // 1. Inicializar Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Autenticación (se usa el token inicial o se inicia anónimamente)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 3. Definir la ruta de la colección (Datos Públicos)
                const collectionPath = `/artifacts/${appId}/public/data/${COLLECTION_NAME}`;
                const productsColRef = collection(db, collectionPath);
                
                // 4. Lógica de Modo Administrador (inicialización del fallback)
                if (isAdminMode) {
                    adminControls.classList.remove('hidden'); // Mostrar el botón de impresión y carga
                    initMessageContainer.classList.remove('hidden'); 
                    
                    // Comprobación de existencia: Si no hay datos, carga el fallback (INITIAL_PRODUCTS)
                    const snapshot = await getDocs(productsColRef);
                    if (snapshot.empty) {
                        await initializeData(productsColRef, INITIAL_PRODUCTS);
                    } else {
                         // Si ya hay datos, solo mostramos el mensaje de que el modo admin está activo
                         initMessage.textContent = 'Modo Administrador Activo. Use el botón "Cargar Nueva Lista" para actualizar.';
                         setTimeout(() => initMessageContainer.classList.add('hidden'), 5000); 
                    }
                } else {
                    initMessageContainer.classList.add('hidden');
                }
                
                // 5. Establecer un listener en tiempo real (onSnapshot) para leer los datos
                onSnapshot(productsColRef, (snapshot) => {
                    const products = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        products.push({ id: doc.id, ...data }); 
                    });

                    products.sort((a, b) => (a.descripcion_es || '').localeCompare(a.descripcion_es || ''));

                    renderTable(products);
                    loadingMessage.classList.add('hidden');

                }, (error) => {
                    console.error("Error al obtener los datos de Firestore:", error);
                    loadingMessage.classList.add('hidden');
                    errorMessage.textContent = `Error de conexión: Missing or insufficient permissions. Revise sus reglas de seguridad para Firestore.`;
                    errorMessage.classList.remove('hidden');
                });
                
            } catch (e) {
                console.error("Error fatal en la inicialización:", e);
                loadingMessage.classList.add('hidden');
                errorMessage.textContent = `No se pudo iniciar la aplicación: ${e.message}`;
                errorMessage.classList.remove('hidden');
            }
        }

        // Función para renderizar la tabla
        function renderTable(products) {
            productsListBody.innerHTML = ''; // Limpiar la tabla

            if (products.length === 0) {
                productsListBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="py-4 text-center text-gray-500">
                            No hay productos cargados. Por favor, cargue la lista usando el modo administrador.
                        </td>
                    </tr>
                `;
                return;
            }

            products.forEach(product => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'transition', 'duration-150');
                
                const descEs = product.descripcion_es || 'N/A';
                const descEn = product.description_en || 'N/A';
                const price = formatPrice(product.precio);

                row.innerHTML = `
                    <td class="py-3 px-6">${descEs}</td>
                    <td class="py-3 px-6 text-gray-500">${descEn}</td>
                    <td class="py-3 px-6 text-right font-semibold text-teal-600">${price}</td>
                `;
                productsListBody.appendChild(row);
            });
        }

        // Inicializar la aplicación al cargar la ventana
        window.onload = initApp;
    </script>
    
    <!-- Aviso de seguridad (no visible para el usuario) -->

</body>
</html>